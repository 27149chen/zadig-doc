---
title: 基于 Helm 命令安装
date: 2021-05-21 13:39:42
permalink:  /install/helm-deploy/
---

本文主要介绍如何使用 Helm 来安装 Zadig 系统。

### 前置条件
1. 安装 Helm v3.1+，这是一个简单的命令行工具，可以从[此处](https://github.com/helm/helm/releases)获取。
2. Kubernetes  v1.12.0+ 版本 <br>

### 步骤 1：创建 Namespace
添加 Zadig 官方 Chart 仓库。

```
helm repo add koderover-chart https://koderover.tencentcloudcr.com/chartrepo/chart
```

创建 namespace。

```
kubectl create ns zadig
```

### 步骤 2：安装 Storage (可选)
这一步主要是安装 MongoDB 和 S3 Storage，用于存储系统数据、容器日志等，如果您有这两项资源，可以跳过此步骤。

```
helm upgrade --timeout=20m --install zadig-storage --namespace zadig --set-string persistence.directory=true --version 1.0.0 koderover-chart/storage --wait
```
安装之后可以确认下 Pod 状态是否正常
```
kubectl get pod -n zadig -l app.kubernetes.io/instance=zadig-storage
```
### 步骤 3：安装 Ingress Controller
```
helm upgrade --timeout=5m --install zadig-nginx-ingress --namespace zadig --version 1.4.1 koderover-chart/nginx-ingress --wait
```
安装之后可以确认下 Pod 状态是否正常
```
kubectl get pod -n zadig -l app=nginx-ingress
```

### 步骤 4：安装 Zadig
> 请注意，如果跳过了 Storage 的安装步骤，安装 Zadig 时需要设置 `global.mongo.connectionString` 和 `global.mongo.db`两个变量值。
```
helm upgrade --timeout=10m --install zadig-core --namespace zadig --version 1.0.0 koderover-chart/zadig --wait
```
安装之后可以确认下 Pod 状态是否正常
```
kubectl get pod -n zadig -l app.kubernetes.io/instance=zadig-core
```
## Chart 可选参数
> 请注意，直接安装上面 Chart 意味着它将使用默认模板值，您可以根据实际需要改变这些默认值。

#### 以下是几个 Chart 可选的参数列表：
下表中列出了 Storage Chart 的可配置参数及其默认值。

参数 | 描述 | 默认值
:--: | :--: |:--:
mongo.resources.limits.cpu|mongo 的 CPU 资源限制|1
mongo.resources.limits.memory|mongo 的内存资源限制|1Gi
mongo.resources.requests.cpu|mongo 请求的 CPU 资源|0.2
mongo.resources.requests.memory|mongo 请求的内存资源|200Mi
s3.resources.limits.cpu|S3 的 CPU 资源限制|1
s3.resources.limits.memory|S3 的内存资源限制|1Gi
s3.resources.requests.cpu|S3 请求的 CPU 资源|0.2
s3.resources.requests.memory|S3 请求的内存资源|200Mi
persistence.directory|是否安装 PV|false
persistence.storageSize|存储空间大小|10G
persistence.storageClassName |storageclasses名称|-

下表中列出了 Ingress Controller Chart 的可配置参数及其默认值。

参数 | 描述 | 默认值
:--: | :--: |:--:
controller.ingressClass|IngressClass 名称|kr-nginx
controller.service.type|Service 类型|LoadBalancer

下表中列出了 Zadig Chart 的可配置参数及其默认值。

参数 | 描述 | 默认值
:--: | :--: |:--:
global.host|访问地址，支持域名和 IP|githubid.ko.coderover.cn
global.replicas|aslan 服务实例数|1
zadig-core.warpdrive.replicas|warpdrive 服务实例数|2
global.mongo.connectionString|MongoDB 地址|mongodb://kr-storage:27017
global.mongo.db|MongoDB 数据库名称|zadig
zadig-core.defaultIngressClass|IngressClass 名称|kr-nginx

## 访问系统

Zadig 系统请求需要经过集群的 Ingress Controller，Ingress Controller Service 类型不同，访问方式不同。

### Type：LoadBalancer（默认）

安装结束后，查看集群的 Ingress Controller Service `EXTERNAL-IP`，
1. 如果使用 IP 访问，请将 Zadig Chart 中 `global.host` 设置为 Ingress Controller Service 被分配的 `EXTERNAL-IP` 值，使用 `EXTERNAL-IP` 访问。
2. 如果使用域名访问，请将 Zadig Chart 中 `global.host` 设置为访问域名 ，并将该域名 DNS 解析到 `EXTERNAL-IP`值，使用所配置的域名访问。

### Type：NodePort

获得 Kubernetes 集群任一节点的公网 IP 地址，并查看集群的 Ingress Controller Service 80 对应的节点端口，如下图所示。

![获取 port](./_images/helm-get-port.png)

1. 如果使用 IP 访问，请将 Zadig Chart 中 `global.host` 设置为 Kubernetes 节点公网 IP 地址，通过` IP:节点端口`方式访问。
2. 将安装 Zadig Chart 时设置`global.host`的域名，DNS 解析到 Kubernetes 节点公网 IP 地址，通过`域名:节点端口`方式访问。

## Helm Charts 卸载
> 注意：只有当您完全知晓每项操作所带来的结果，再去执行该操作。

如果您安装过 Zadig，请执行以下命令卸载。
```
helm uninstall zadig-core -n zadig
```
如果您安装过 Storage，请执行以下命令卸载。
```
helm uninstall zadig-storage -n zadig
```
如果您安装过 Ingress Controller，请执行以下命令卸载。
```
helm uninstall zadig-nginx-ingress -n zadig
```

